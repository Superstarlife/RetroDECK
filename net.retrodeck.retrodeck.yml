app-id: net.retrodeck.retrodeck
runtime: org.kde.Platform
runtime-version: '5.15-21.08'
sdk: org.kde.Sdk
# Needed for rpcs3
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm13
# /Needed for rpcs3
# Needed for Yuzu
base: io.qt.qtwebengine.BaseApp
base-version: 5.15-21.08
# /Needed for Yuzu
command: retrodeck.sh

finish-args:
   - --socket=x11
   - --socket=wayland
   - --socket=pulseaudio
   - --share=ipc
   - --share=network
   - --device=all
   - --filesystem=~/retrodeck:create
   - --filesystem=/run/media
   - --filesystem=/media
   - --allow=multiarch
   - --talk-name=org.freedesktop.ScreenSaver
   - --talk-name=org.freedesktop.PowerManagement.Inhibit
   - --talk-name=org.freedesktop.login1
   - --filesystem=xdg-run/app/com.discordapp.Discord:create
  # Yuzu
   - --filesystem=home:ro
  # - --filesystem=/run/media:ro
  # Dolphin
   - --allow=bluetooth
  #- --env=QT_QPA_PLATFORM=xcb not sure if this will break something
  # rpcs3
   - --socket=fallback-x11

cleanup:
  # ES-DE
  - /include
  - /share/ffmpeg
  - /lib/cmake
  #- /lib/debug
  - /lib/pkgconfig
  # Yuzu
  - /include
  - /bin/glslangValidator
  - /bin/zip*
  - /bin/zstd*
  - /lib/pkg-config
  - /share/doc
  - /share/man
  - /src
  - '*.a'
  - '*.la'
cleanup-commands:
  # Yuzu
  - /app/cleanup-BaseApp.sh

modules:

  - name: retrodeck
    buildsystem: simple
    build-commands:

        # Prep the ES-DE and RetroArch config files
        - rm -rf /app/share/emulationstation/resources/systems/unix/es_find_rules.xml
        - cp es_find_rules.xml /app/share/emulationstation/resources/systems/unix/
        - rm -rf /app/share/emulationstation/resources/systems/unix/es_systems.xml
        - cp es_systems.xml /app/share/emulationstation/resources/systems/unix/
        # These must be put in home folder, managed by retrodeck.sh
        - mkdir -p ${FLATPAK_DEST}/retrodeck/
        - cp es_settings.xml ${FLATPAK_DEST}/retrodeck/es_settings.xml

        # Logo, res
        - rm -f /app/share/emulationstation/resources/graphics/splash.svg
        - cp splash.svg /app/share/emulationstation/resources/graphics/splash.svg
        - cp icon.svg /app/share/icons/hicolor/scalable/apps/net.retrodeck.retrodeck.svg

        # Tools
        - mkdir -p ${FLATPAK_DEST}/retrodeck/tools/
        - cp start-*.sh ${FLATPAK_DEST}/retrodeck/tools/
        - cp move-roms.sh ${FLATPAK_DEST}/retrodeck/tools/
        - cp tools-gamelist.xml ${FLATPAK_DEST}/retrodeck/
        
        - cp retrodeck.sh /app/bin/retrodeck.sh
        - chmod +x /app/bin/retrodeck.sh
        
        # Desktop entry
        - cp net.retrodeck.retrodeck.desktop /app/share/applications/net.retrodeck.retrodeck.desktop

        # Steam Grids
        - mkdir -p ${FLATPAK_DEST}/retrodeck/steam/
        - cp banner_main.png ${FLATPAK_DEST}/retrodeck/steam/
        - cp poster_main.png ${FLATPAK_DEST}/retrodeck/steam/
        - cp poster_main_nodecklogo.png ${FLATPAK_DEST}/retrodeck/steam/

        # Configuring emulators:
        - mkdir -p ${FLATPAK_DEST}/retrodeck/emu-configs/
        # RetroArch
        - cp retroarch.cfg ${FLATPAK_DEST}/retrodeck/emu-configs/
        # Dolphin 
        - cp Dolphin.ini ${FLATPAK_DEST}/retrodeck/emu-configs/
        # Yuzu
        - cp yuzu-qt-config.ini ${FLATPAK_DEST}/retrodeck/emu-configs/
        # Pcsx2
        - cp PCSX2_ui.ini ${FLATPAK_DEST}/retrodeck/emu-configs/
        # MelonDS
        - cp melonDS.ini ${FLATPAK_DEST}/retrodeck/emu-configs/
        # CITRA
        - cp citra-qt-config.ini ${FLATPAK_DEST}/retrodeck/emu-configs/
        # RPCS3
        - cp config.yml ${FLATPAK_DEST}/retrodeck/emu-configs/

        # Placing appdata
        - mkdir -p ${FLATPAK_DEST}/share/appdata
        - cp net.retrodeck.retrodeck.appdata.xml ${FLATPAK_DEST}/share/appdata


    #cleanup: ['*']
    sources:
      - type: file
        path: es_find_rules.xml
      - type: file
        path: es_settings.xml
      - type: file
        path: es_systems.xml
      - type: file
        path: retrodeck.sh
      - type: dir
        path: emu-configs
      - type: file
        path: tools-gamelist.xml
      - type: dir
        path: res
      - type: dir
        path: res/steam
      - type: dir
        path: tools
      - type: file
        path: net.retrodeck.retrodeck.desktop
      - type: file
        path: net.retrodeck.retrodeck.appdata.xml
      
